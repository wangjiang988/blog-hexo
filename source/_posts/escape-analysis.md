---
title: JAVA逃逸分析、栈上分配、标量替换、同步消除
date: 2020-07-28 17:50:15
tags:
    - java
    - jmm
    - escape-analysis
    - 高并发
categories:
    - [java]
    - [jvm]
---

## 说明

逃逸分析相关jvm优化

逃逸分析分基本行为就是分析对象动态作用域：当一个对象被定义后，它可能被外部方法引用，例如作为调用参数被传递到其他方法中，称为方法逃逸。甚至还有可能被外部线程访问到，譬如赋值给类变量或者可以在其他线程中访问的实例变量，称为线程逃逸。
如果能证明一个对象不会逃逸到线程或方法以外，也就是别的线程或方法无法通过任何的形式访问到这个对象，则可能为这个变量进行一些高效的优化。
<!--more-->


### 非逃逸对象可以做以下优化

栈上分配

同步消除

标量替换



### 栈上分配

通过-XX:-DoEscapeAnalysis关闭逃逸分析


如题：

如果确定一个对象不会逃逸出方法之外，那让这个对象直接在栈上分配将是一个不错的选择，对象所占用的内存空间就会随着栈帧的出栈而被释放。

### 同步消除

如果对象没有出现线程逃逸，那该对象的读写就不会存在资源的竞争，不存在资源的竞争，则可以消除对该对象的同步锁。

通过-XX:+EliminateLocks可以开启同步消除,进行测试执行的效率

### 标量替换

> 概念
1.标量和聚合量
标量即不可被进一步分解的量，而JAVA的基本数据类型就是标量（如：int，long等基本数据类型以及reference类型等），标量的对立就是可以被进一步分解的量，而这种量称之为聚合量。而在JAVA中对象就是可以被进一步分解的聚合量。

2.替换过程
通过逃逸分析确定该对象不会被外部访问，并且对象可以被进一步分解时，JVM不会创建该对象，而会将该对象成员变量分解若干个被这个方法使用的成员变量所代替。这些代替的成员变量在栈帧或寄存器上分配空间。

通过
-XX:+EliminateAllocations可以开启标量替换  
-XX:+PrintEliminateAllocations查看标量替换情况（Server VM 非Product版本支持）


## 参考网址

https://www.jianshu.com/p/580f17760f6e

https://www.jianshu.com/p/6dce54a204d5




